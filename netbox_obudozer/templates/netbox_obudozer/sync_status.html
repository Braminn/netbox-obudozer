{% extends 'base/layout.html' %}
{% load buttons %}

{% block title %}Синхронизация vCenter{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>
                <i class="mdi mdi-sync"></i>
                Синхронизация vCenter
            </h1>
            <hr>
        </div>
    </div>

    <!-- Статус синхронизации -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-information"></i> Статус синхронизации
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="small text-muted">Всего VM</div>
                            <div class="h3">{{ sync_status.total_vms }}</div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">Активные</div>
                            <div class="h3 text-success">
                                <i class="mdi mdi-play-circle"></i> {{ sync_status.active_vms }}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">Остановленные</div>
                            <div class="h3 text-secondary">
                                <i class="mdi mdi-stop-circle"></i> {{ sync_status.offline_vms }}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="small text-muted">Недоступные</div>
                            <div class="h3 text-danger">
                                <i class="mdi mdi-alert-circle"></i> {{ sync_status.failed_vms }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="small text-muted">Статус vCenter</div>
                            <div class="h3">
                                {% if sync_status.vcenter_available %}
                                    <span class="badge bg-success">
                                        <i class="mdi mdi-check-circle"></i> Доступен
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="mdi mdi-close-circle"></i> Недоступен
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    {% if sync_status.last_sync %}
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="mdi mdi-clock-outline"></i>
                                Последняя синхронизация: {{ sync_status.last_sync|date:"d.m.Y H:i:s" }}
                            </small>
                        </div>
                    {% else %}
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="mdi mdi-alert"></i>
                                Синхронизация еще не выполнялась
                            </small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопка синхронизации -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-play"></i> Запуск синхронизации
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Будет запущена фоновая задача синхронизации виртуальных машин из vCenter в NetBox.
                        Прогресс выполнения будет отображаться ниже в реальном времени.
                        Новые VM будут созданы, существующие VM обновлены, а отсутствующие VM помечены как недоступные (failed).
                    </p>

                    {% if sync_status.vcenter_available %}
                        <form id="sync-form" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-lg" id="sync-button">
                                <i class="mdi mdi-sync"></i> Запустить синхронизацию (фоновая задача)
                            </button>
                        </form>
                    {% else %}
                        <button class="btn btn-primary btn-lg" disabled>
                            <i class="mdi mdi-sync"></i> Запустить синхронизацию
                        </button>
                        <div class="alert alert-danger mt-3 mb-0">
                            <i class="mdi mdi-alert"></i>
                            <strong>Ошибка:</strong> vCenter недоступен. Проверьте настройки подключения.
                        </div>
                    {% endif %}

                    <!-- Блок отображения прогресса синхронизации -->
                    <div id="sync-progress-container" class="mt-4" style="display: none;">
                        <hr>
                        <h5 class="mb-3">
                            <i class="mdi mdi-progress-clock"></i> Прогресс синхронизации (Job #<span id="job-id"></span>)
                        </h5>

                        <!-- Статус -->
                        <div class="mb-3">
                            <strong>Статус:</strong>
                            <span id="job-status-badge"></span>
                        </div>

                        <!-- Логи -->
                        <div class="card">
                            <div class="card-header">
                                <strong><i class="mdi mdi-text"></i> Лог выполнения</strong>
                            </div>
                            <div class="card-body p-0">
                                <div id="job-log" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px;">
                                    <div class="text-muted">Ожидание запуска...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Информация -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="mdi mdi-help-circle"></i> Информация
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Соответствие статусов VM:</h6>
                    <ul>
                        <li><strong>Active (Активна):</strong> VM запущена в vCenter</li>
                        <li><strong>Offline (Остановлена):</strong> VM остановлена в vCenter</li>
                        <li><strong>Failed (Недоступна):</strong> VM не найдена в vCenter</li>
                    </ul>

                    <h6 class="mt-3">Процесс синхронизации:</h6>
                    <ol>
                        <li>Подключается к vCenter и получает список VM</li>
                        <li>Создает новые VM, найденные в vCenter</li>
                        <li>Обновляет статус существующих VM</li>
                        <li>Помечает отсутствующие в vCenter VM как "failed"</li>
                    </ol>

                    <p class="text-muted mb-0 mt-3">
                        <i class="mdi mdi-information"></i>
                        <strong>Примечание:</strong> Для управления отдельными VM используйте стандартный раздел NetBox
                        <a href="{% url 'virtualization:virtualmachine_list' %}">Виртуальные машины</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const syncForm = document.getElementById('sync-form');
    const syncButton = document.getElementById('sync-button');
    const progressContainer = document.getElementById('sync-progress-container');
    const jobIdSpan = document.getElementById('job-id');
    const jobStatusBadge = document.getElementById('job-status-badge');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const jobLog = document.getElementById('job-log');

    let updateInterval;
    let lastStatus = null;

    if (syncForm) {
        syncForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Отключаем кнопку
            syncButton.disabled = true;
            syncButton.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> Запуск...';

            // Получаем CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Отправляем AJAX запрос
            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams(new FormData(syncForm))
            })
            .then(response => response.json())
            .then(data => {
                console.log('POST response:', data);
                if (data.success) {
                    // Показываем контейнер прогресса
                    progressContainer.style.display = 'block';
                    jobIdSpan.textContent = data.job_id;

                    // Обновляем лог с информацией о запуске
                    jobLog.innerHTML = `<div class="text-info">✓ Задача #${data.job_id} создана, запрашиваю статус...</div>`;

                    // Прокручиваем к блоку прогресса
                    progressContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                    // Запускаем polling
                    startJobPolling(data.job_id);
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                    syncButton.disabled = false;
                    syncButton.innerHTML = '<i class="mdi mdi-sync"></i> Запустить синхронизацию (фоновая задача)';
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при запуске синхронизации: ' + error.message);
                syncButton.disabled = false;
                syncButton.innerHTML = '<i class="mdi mdi-sync"></i> Запустить синхронизацию (фоновая задача)';
            });
        });
    }

    function startJobPolling(jobId) {
        const apiUrl = `/api/core/jobs/${jobId}/`;

        function updateJobStatus() {
            fetch(apiUrl, {
                headers: {
                    'Accept': 'application/json',
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Job data:', data);
                console.log('Job status:', data.status);
                console.log('Job data.data:', data.data);

                // NetBox возвращает статус как объект {value: 'completed', label: 'Completed'}
                const statusValue = data.status.value || data.status;

                // Обновляем статус
                updateStatusBadge(statusValue, data.status.label || statusValue);

                // Обновляем логи
                updateLogs(data);

                // Проверяем завершение
                if (statusValue === 'completed' || statusValue === 'failed' || statusValue === 'errored') {
                    if (lastStatus !== statusValue) {
                        showCompletionNotification(data);

                        // Возвращаем кнопку в рабочее состояние
                        syncButton.disabled = false;
                        syncButton.innerHTML = '<i class="mdi mdi-sync"></i> Запустить синхронизацию (фоновая задача)';
                    }
                    clearInterval(updateInterval);
                }

                lastStatus = statusValue;
            })
            .catch(error => {
                console.error('Ошибка обновления статуса job:', error);
                jobLog.innerHTML = `<div class="text-danger">Ошибка получения статуса: ${error.message}</div>`;
            });
        }

        // Первое обновление сразу
        updateJobStatus();

        // Запускаем обновление каждые 2 секунды
        updateInterval = setInterval(updateJobStatus, 2000);
    }

    function updateStatusBadge(statusValue, statusLabel) {
        const badges = {
            'pending': '<span class="badge bg-secondary"><i class="mdi mdi-clock-outline"></i> В очереди</span>',
            'running': '<span class="badge bg-primary"><i class="mdi mdi-loading mdi-spin"></i> Выполняется</span>',
            'completed': '<span class="badge bg-success"><i class="mdi mdi-check-circle"></i> Завершено</span>',
            'failed': '<span class="badge bg-danger"><i class="mdi mdi-alert-circle"></i> Ошибка</span>',
            'errored': '<span class="badge bg-danger"><i class="mdi mdi-alert-circle"></i> Ошибка</span>'
        };
        jobStatusBadge.innerHTML = badges[statusValue] || statusLabel || statusValue;
    }

    function updateLogs(data) {
        // Проверяем разные возможные структуры логов в NetBox
        let logs = null;

        if (data.data && data.data.log && data.data.log.length > 0) {
            logs = data.data.log;
        } else if (data.log_entries && data.log_entries.length > 0) {
            logs = data.log_entries;
        } else if (data.data && data.data.output) {
            // Если есть просто текстовый вывод
            jobLog.innerHTML = `<pre style="white-space: pre-wrap; margin: 0;">${escapeHtml(data.data.output)}</pre>`;
            jobLog.scrollTop = jobLog.scrollHeight;
            return;
        }

        if (logs && logs.length > 0) {
            let logsHtml = '';
            logs.forEach(entry => {
                const time = entry.created ? new Date(entry.created).toLocaleTimeString('ru-RU') : '';
                const levelMap = {
                    'DEBUG': 'secondary',
                    'INFO': 'info',
                    'WARNING': 'warning',
                    'ERROR': 'danger',
                    'CRITICAL': 'danger'
                };
                const levelName = entry.level_name || entry.level || 'INFO';
                const levelClass = levelMap[levelName] || 'secondary';
                const message = entry.message || entry.msg || String(entry);

                logsHtml += `
                    <div class="mb-1" style="line-height: 1.6;">
                        ${time ? `<span class="text-muted">${time}</span>` : ''}
                        <span class="badge bg-${levelClass}">${levelName}</span>
                        <span>${escapeHtml(message)}</span>
                    </div>
                `;
            });
            jobLog.innerHTML = logsHtml;

            // Автоскролл вниз
            jobLog.scrollTop = jobLog.scrollHeight;
        } else if (data.status === 'pending') {
            jobLog.innerHTML = '<div class="text-muted">Задача в очереди, ожидание запуска...</div>';
        } else if (data.status === 'running') {
            jobLog.innerHTML = '<div class="text-info"><i class="mdi mdi-loading mdi-spin"></i> Выполняется, ожидание логов...</div>';
        } else {
            // Отладочная информация если логов нет
            jobLog.innerHTML = `<div class="text-warning">Логи пока не доступны. Статус: ${data.status}<br>Структура data: ${JSON.stringify(data.data || {}, null, 2)}</div>`;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showCompletionNotification(data) {
        // Получаем статистику из логов
        let stats = {
            created: 0,
            updated: 0,
            unchanged: 0,
            marked_missing: 0,
            duration: 0
        };

        // Ищем логи в разных местах
        let logs = null;
        if (data.data && data.data.log) {
            logs = data.data.log;
        } else if (data.log_entries) {
            logs = data.log_entries;
        }

        // Парсим статистику из логов
        if (logs && logs.length > 0) {
            logs.forEach(log => {
                const msg = log.message || log.msg || String(log);
                if (msg.includes('Создано VM:')) {
                    const match = msg.match(/Создано VM: (\d+)/);
                    if (match) stats.created = parseInt(match[1]);
                }
                if (msg.includes('Обновлено VM:')) {
                    const match = msg.match(/Обновлено VM: (\d+)/);
                    if (match) stats.updated = parseInt(match[1]);
                }
                if (msg.includes('Без изменений:')) {
                    const match = msg.match(/Без изменений: (\d+)/);
                    if (match) stats.unchanged = parseInt(match[1]);
                }
                if (msg.includes('Помечено недоступными:')) {
                    const match = msg.match(/Помечено недоступными: (\d+)/);
                    if (match) stats.marked_missing = parseInt(match[1]);
                }
                if (msg.includes('Длительность:')) {
                    const match = msg.match(/Длительность: ([\d.]+) сек/);
                    if (match) stats.duration = parseFloat(match[1]);
                }
            });
        }

        // Формируем сообщение
        const statusValue = data.status.value || data.status;
        const isSuccess = statusValue === 'completed';
        const alertType = isSuccess ? 'success' : 'danger';
        const icon = isSuccess ? 'check-circle' : 'alert-circle';

        let message = isSuccess
            ? '✅ <strong>Синхронизация завершена успешно!</strong>'
            : '❌ <strong>Синхронизация завершена с ошибками!</strong>';

        // Добавляем статистику если есть
        const hasStats = stats.created > 0 || stats.updated > 0 || stats.unchanged > 0;
        if (hasStats) {
            message += '<br><br>';
            message += `<ul class="mb-0" style="list-style: none; padding-left: 0;">`;
            message += `<li><strong>Создано:</strong> ${stats.created}</li>`;
            message += `<li><strong>Обновлено:</strong> ${stats.updated}</li>`;
            message += `<li><strong>Без изменений:</strong> ${stats.unchanged}</li>`;
            if (stats.marked_missing > 0) {
                message += `<li><strong>Помечено недоступными:</strong> ${stats.marked_missing}</li>`;
            }
            if (stats.duration > 0) {
                message += `<li class="mt-2"><strong>Длительность:</strong> ${stats.duration.toFixed(2)} сек</li>`;
            }
            message += `</ul>`;
        }

        // Создаем уведомление (стандартный NetBox alert)
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${alertType} alert-dismissible fade show mt-3`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            <i class="mdi mdi-${icon}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Вставляем в начало контейнера прогресса
        progressContainer.insertBefore(alertDiv, progressContainer.firstChild);

        // Прокручиваем к уведомлению
        alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
})();
</script>
{% endblock %}
